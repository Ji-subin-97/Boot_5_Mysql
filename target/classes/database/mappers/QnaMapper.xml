<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.iu.b5.board.qna.QnaMapper">

	<!-- Insert 글쓰기 -->
	<insert id="setInsert" parameterType="BoardVO" useGeneratedKeys="true" keyProperty="num">
		insert into qna (num, title, contents, writer, hit, regDate, ref, step, depth)
		values (#{num}, #{title}, #{contents}, #{writer}, 0, sysdate(), 0, 0, 0)
	</insert>
	
	<insert id="setReplyInsert" parameterType="BoardVO" useGeneratedKeys="true" keyProperty="num">
		insert into qna (num, title, contents, writer, hit, regDate, ref, step, depth)
		values (null, #{title}, #{contents}, #{writer}, 0, sysdate(), 
		(select qna_ref.ref from (select ref from qna where num = #{num}) as qna_ref),
		(select qna_step.step from (select step+1 from qna where num = #{num}) as qna_step), 
		(select qna_depth.depth from (select depth+1 from qna where num = #{num}) as qna_depth))
	</insert>
	
	<update id="setReplyUpdate" parameterType="BoardVO">
		UPDATE
			qna
		SET
			step = step + 1
		WHERE
			ref = 
			(
			SELECT 
				qna_ref.ref
			FROM
				(
					SELECT
						ref
					FROM
						qna
					WHERE
						num = #{num}
				) AS qna_ref
			)
			AND
			step >
			(
			SELECT 
				qna_step.step
			FROM
				(
					SELECT
						step
					FROM
						qna
					WHERE
						num = #{num}
				) AS qna_step
			)
			
	</update>
	
	<update id="setRefUpdate" parameterType="BoardVO">
		UPDATE
			qna
		SET
			ref = #{num}
		WHERE
			num = #{num}
	</update>
	
	<!-- Update 글수정 -->
	<update id="setUpdate" parameterType="BoardVO">
		UPDATE
			qna
		SET
			title = #{title},
			contents = #{contents}
		WHERE
			num = #{num}
	</update>
	
	<!-- Update 조회수 수정 -->
	<update id="setHitUpdate" parameterType="BoardVO">
		UPDATE
			qna
		SET
			hit = hit + 1
		WHERE
			num = #{num}
	</update>
	
	<!-- Delete 글삭제 -->
	<delete id="setDelete" parameterType="BoardVO">
		DELETE
		FROM
			qna
		WHERE
			num = #{num}
	</delete>
	
	<!-- Select 글 하나 조회 -->
	<select id="getSelectOne" parameterType="BoardVO" resultType="QnaVO">
		SELECT *
		FROM
			qna
		WHERE
			num = #{num}
	</select>
	
	<!-- Select 글 리스트 조회 -->
	<select id="getSelectList" parameterType="Pager" resultType="QnaVO">
		SELECT *
		FROM
			qna
		<if test="search != null">
		WHERE
			<choose>
				<when test="kind == 'title'">
					title
				</when>
				
				<when test="kind == 'contents'">
					contents
				</when>
				
				<otherwise>
					 writer
				</otherwise>
			</choose>
		LIKE CONCAT('%', #{search}, '%')
		</if>
		ORDER BY
			ref desc, step asc
		LIMIT
			#{startRow}, #{perPage}
	</select>
	
	
	<!-- Select 전체 갯수 구하기 -->
	<select id="getTotalCount" parameterType="Pager" resultType="Long">
		SELECT
			COUNT(num)
		FROM
			qna
		<if test="search != null">
		WHERE
			<choose>
				<when test="kind == 'title'">
					title
				</when>
				
				<when test="kind == 'contents'">
					contents
				</when>
				
				<otherwise>
					 writer
				</otherwise>
			</choose>
		LIKE CONCAT('%', #{search}, '%')
		</if>
	</select>
	
</mapper>